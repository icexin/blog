<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>Running Go Application on Bare Metal - icexin的站点</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=author content="icexin"><meta name=description content="In the process of writing eggos, I found that removing the hardware initialization code, the main program is actually an ordinary Go program. Like other Go programs, the main function is used as the entry point, but it never returns.
Can other ordinary programs also run on bare metal? The answer is yes. I extracted the kernel code of eggos as a separate Go library. Other applications can run on bare metal like eggos by writing import _ &amp;quot;github."><meta name=keywords content="golang,os,blockchain">
<meta name=generator content="Hugo 0.87.0 with theme even">
<link rel=canonical href=https://icexin.com/post/running-go-application-on-bare-metal/>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/manifest.json>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous>
<meta property="og:title" content="Running Go Application on Bare Metal">
<meta property="og:description" content="In the process of writing eggos, I found that removing the hardware initialization code, the main program is actually an ordinary Go program. Like other Go programs, the main function is used as the entry point, but it never returns.
Can other ordinary programs also run on bare metal? The answer is yes. I extracted the kernel code of eggos as a separate Go library. Other applications can run on bare metal like eggos by writing import _ &#34;github.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://icexin.com/post/running-go-application-on-bare-metal/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-08-09T22:17:27+08:00">
<meta property="article:modified_time" content="2021-08-09T22:17:27+08:00">
<meta itemprop=name content="Running Go Application on Bare Metal">
<meta itemprop=description content="In the process of writing eggos, I found that removing the hardware initialization code, the main program is actually an ordinary Go program. Like other Go programs, the main function is used as the entry point, but it never returns.
Can other ordinary programs also run on bare metal? The answer is yes. I extracted the kernel code of eggos as a separate Go library. Other applications can run on bare metal like eggos by writing import _ &#34;github."><meta itemprop=datePublished content="2021-08-09T22:17:27+08:00">
<meta itemprop=dateModified content="2021-08-09T22:17:27+08:00">
<meta itemprop=wordCount content="866">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Running Go Application on Bare Metal">
<meta name=twitter:description content="In the process of writing eggos, I found that removing the hardware initialization code, the main program is actually an ordinary Go program. Like other Go programs, the main function is used as the entry point, but it never returns.
Can other ordinary programs also run on bare metal? The answer is yes. I extracted the kernel code of eggos as a separate Go library. Other applications can run on bare metal like eggos by writing import _ &#34;github."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Programmer</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<a href=/>
<li class=mobile-menu-item>主页</li>
</a><a href=/works/>
<li class=mobile-menu-item>作品</li>
</a><a href=/post/>
<li class=mobile-menu-item>归档</li>
</a><a href=/tags/>
<li class=mobile-menu-item>标签</li>
</a><a href=/categories/>
<li class=mobile-menu-item>分类</li>
</a>
</ul>
</nav>
<div class=container id=mobile-panel>
<header id=header class=header>
<div class=logo-wrapper>
<a href=/ class=logo>Programmer</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=/>主页</a>
</li><li class=menu-item>
<a class=menu-item-link href=/works/>作品</a>
</li><li class=menu-item>
<a class=menu-item-link href=/post/>归档</a>
</li><li class=menu-item>
<a class=menu-item-link href=/tags/>标签</a>
</li><li class=menu-item>
<a class=menu-item-link href=/categories/>分类</a>
</li>
</ul>
</nav>
</header>
<main id=main class=main>
<div class=content-wrapper>
<div id=content class=content>
<article class=post>
<header class=post-header>
<h1 class=post-title>Running Go Application on Bare Metal</h1>
<div class=post-meta>
<span class=post-time> 2021-08-09 </span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class="post-toc-content always-active">
<nav id=TableOfContents>
<ul>
<li><a href=#use-go-to-write-your-own-unikernel>Use Go to write your own unikernel</a>
<ul>
<li><a href=#hello-eggos>Hello Eggos</a></li>
<li><a href=#concurrent-prime-sieve>Concurrent prime sieve</a></li>
<li><a href=#http-server>HTTP server</a></li>
<li><a href=#interactive-program>Interactive program</a></li>
<li><a href=#graphics-and-animation>Graphics and Animation</a></li>
<li><a href=#hacking-system-call>Hacking system call</a></li>
</ul>
</li>
<li><a href=#run-the-kernel-on-the-real-machine>Run the kernel on the real machine</a></li>
<li><a href=#conclusion>Conclusion</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<p>In the process of writing <a href=https://github.com/icexin/eggos>eggos</a>, I found that removing the hardware initialization code, the main program is actually an ordinary Go program. Like other Go programs, the main function is used as the entry point, but it never returns.</p>
<p>Can other ordinary programs also run on bare metal? The answer is yes. I extracted the kernel code of eggos as a separate Go library. Other applications can run on bare metal like eggos by writing <code>import _ "github.com/icexin/eggos"</code>.</p>
<p>If an ordinary Go program wants to run on bare metal, in addition to import eggos, it also needs to pass many complex parameters to the compiler. I encapsulated these compilation processes and wrote a program called <code>egg</code>. In this way, you can use <code>egg</code> to compile, package, and run the Go language kernel written by yourself.</p>
<h1 id=use-go-to-write-your-own-unikernel>Use Go to write your own unikernel</h1>
<p>There are several examples in the main code repository of eggos, in the <a href=https://github.com/icexin/eggos/tree/main/app/examples>examples</a> directory, the following will introduce these examples one by one.</p>
<p>It should be noted that all examples depend on the following:</p>
<ul>
<li>Go1.16.x</li>
<li>The Qemu emulator</li>
</ul>
<p>The <code>egg</code> program can be downloaded from eggos&rsquo;s <a href=https://github.com/icexin/eggos/releases>Release</a> page, or run <code>go install github.com/icexin/eggos/cmd/egg@latest</code> to get it.</p>
<p>Our examples are all running in the qemu emulator. If you want to run these examples on a real machine, you can refer to the <code>graphic</code> example and use the iso image to run on the real machine.</p>
<h2 id=hello-eggos>Hello Eggos</h2>
<p>The code is in <a href=https://github.com/icexin/eggos/tree/main/app/examples/helloworld/main.go>hello world</a></p>
<p>The first example is relatively simple, it simply outputs <code>hello eggos</code> to check whether your environment is ready.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>$ <span class=nb>cd</span> helloworld
$ egg run
</code></pre></td></tr></table>
</div>
</div><h2 id=concurrent-prime-sieve>Concurrent prime sieve</h2>
<p>The code is in <a href=https://github.com/icexin/eggos/tree/main/app/examples/prime-sieve/main.go>prime sieve</a></p>
<p>The second example is the classic algorithm for <code>Concurrent prime sieve</code> on the Go official website. This example demonstrates the ability of eggos to use goroutines.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>$ <span class=nb>cd</span> prime-sieve
$ egg run
</code></pre></td></tr></table>
</div>
</div><h2 id=http-server>HTTP server</h2>
<p>The code is in <a href=https://github.com/icexin/eggos/tree/main/app/examples/httpd/main.go>http server</a></p>
<p>The third example shows the eggos network stack, which can run the <code>http</code> package in the Go standard library</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>$ <span class=nb>cd</span> httpd
$ egg run -p 8000:8000
</code></pre></td></tr></table>
</div>
</div><p>Open the browser and enter http://127.0.0.1:8000/hello to access.</p>
<p>Because we are running in qemu, port mapping is used. If running on bare metal, just replace <code>127.0.0.1</code> with the machine IP.</p>
<h2 id=interactive-program>Interactive program</h2>
<p>The code is in <a href=https://github.com/icexin/eggos/tree/main/app/examples/repl/main.go>repl</a></p>
<p>The fourth example shows an example of using input and output to write an interactive program. This example obtains the string entered by the user, calculates its sha1 value, and outputs it to the screen.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>$ <span class=nb>cd</span> repl
$ egg run
</code></pre></td></tr></table>
</div>
</div><p>You can close the program by closing the qemu window.</p>
<h2 id=graphics-and-animation>Graphics and Animation</h2>
<p>The code is in <a href=https://github.com/icexin/eggos/tree/main/app/examples/graphic/main.go>graphic</a></p>
<p>The fifth example demonstrates eggos' ability to manipulate images. The <code>image</code> package in Go&rsquo;s standard library has basic graphics processing capabilities, and eggos has basic image processing capabilities with the help of <a href=https://en.wikipedia.org/wiki/Framebuffer>Frame Buffer</a>.</p>
<p>The code of this example is borrowed from the &ldquo;Go Programming Language&rdquo;. The original example is to generate a <a href=https://en.wikipedia.org/wiki/Lissajous_curve>Lissajous curve</a>
GIF animation, here is a little modification to form an animation on the screen.</p>
<p>This example has more commands than others. The previous example does not involve drawing pictures on the screen. We can use qemu&rsquo;s <code>-kernel</code> parameter to load the kernel. In this mode, qemu will not help us find the <code>frame buffer</code>. But in this example, we need to use grub to help us find the <code>frame buffer</code>, so an iso image containing the grub boot program is generated.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>$ <span class=nb>cd</span> graphic
$ egg pack -o graphic.iso
$ egg run graphic.iso
</code></pre></td></tr></table>
</div>
</div><h2 id=hacking-system-call>Hacking system call</h2>
<p>The code is in <a href=https://github.com/icexin/eggos/tree/main/app/examples/syscall/main.go>syscall</a></p>
<p>Eggos itself only contains some basic Linux system calls to allow Go runtime to run normally, but some third-party libraries may not run normally if they use system calls that are not provided by eggos, so eggos provides the ability to register system calls. This example shows how to register system calls.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>$ <span class=nb>cd</span> syscall
$ egg run
</code></pre></td></tr></table>
</div>
</div><h1 id=run-the-kernel-on-the-real-machine>Run the kernel on the real machine</h1>
<p>In the example of <code>Graphics and Animation</code>, we showed how to package the kernel into an ISO file. This ISO file contains the bootloader, so it can be recognized and loaded and run by the real machine.</p>
<p>The usual way we let the bare metal run the ISO file is to burn the ISO file into the USB drive, then insert the USB drive into the computer, and select the USB drive startup item to run. But here I recommend using <a href=https://www.ventoy.net/>ventoy</a> to make the boot disk. Ventoy will only format the USB disk once, then only need to copy the ISO file to the USB drive, which is very convenient. This is a screenshot of my machine.</p>
<p><img src=https://i.imgur.com/YDlowOQ.gif alt=bare-metal></p>
<h1 id=conclusion>Conclusion</h1>
<p>With the help of the Go package management, we have successfully provided a Go language implementation of <code>libos</code> so that ordinary Go programs can also run on bare metal. This is a very interesting attempt. I hope that the hardware driver can also be modularized into a Go package, so that you can customize your own kernel under the eggos framework as easy as importing a normal Go package!</p>
<p>Happy hacking!</p>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>icexin</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2021-08-09
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<footer class=post-footer>
<nav class=post-nav>
<a class=next href=/post/write-your-own-unikernel/>
<span class="next-text nav-default">将Go程序跑在裸机上之LibOS</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i>
</a>
</nav>
</footer>
</article>
</div>
<script src=https://utteranc.es/client.js repo=icexin/doc-comments issue-term=pathname theme=github-light crossorigin=anonymous async></script>
<noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript>
</div>
</main>
<footer id=footer class=footer>
<div class=social-links>
<a href=http://github.com/icexin class="iconfont icon-github" title=github></a>
<a href=https://icexin.com/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a>
</div>
<div class=copyright>
<span class=power-by>
由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动
</span>
<span class=division>|</span>
<span class=theme-info>
主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span>
<span class=copyright-year>
&copy;
2021<span class=heart><i class="iconfont icon-heart"></i></span><span>icexin</span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class="iconfont icon-up"></i>
</div>
</div>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4S27LHKGHE"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-4S27LHKGHE',{anonymize_ip:!0})}</script>
</body>
</html>